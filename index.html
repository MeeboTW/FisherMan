<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é®®é­šä¸‹å–®ç³»çµ±</title>
  <script src="https://unpkg.com/vue@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    .product, .cart-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled {
      background: gray;
    }
  </style>
</head>

<body>
  <div id="app">
    <h1>ğŸŸ ä»Šæ—¥æ–°é®®æ¼ç²</h1>

    <!-- å•†å“åˆ—è¡¨ -->
    <div class="product" v-for="p in products" :key="p.id">
      <h3>{{ p.Name }}</h3>
      <p>åƒ¹æ ¼ï¼š<b>${{ p.Price }}</b></p>
      <button @click="addToCart(p)">åŠ å…¥è³¼ç‰©è»Š</button>
    </div>

    <hr>

    <!-- è³¼ç‰©è»Š -->
    <h2>ğŸ›’ è³¼ç‰©è»Š ({{ cart.length }} é …)</h2>

    <div v-if="cart.length === 0">
      <p>è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</p>
    </div>

    <div class="cart-item" v-for="c in cart" :key="c.id">
      {{ c.Name }}  
      â€” ${{ c.Price }}  
      Ã— {{ c.quantity }}

      <button style="background:#d32f2f; float:right;" @click="removeFromCart(c)">
        ç§»é™¤
      </button>
    </div>

    <p v-if="cart.length > 0">
      <b>ç¸½è¨ˆï¼š<span style="color:green">${{ cartTotal }}</span></b>
    </p>

    <hr>

    <!-- è¨‚è³¼è³‡è¨Š -->
    <h2>ğŸ‘¤ è¨‚è³¼äººè³‡è¨Š</h2>

    <label>å§“åï¼š<br>
      <input v-model="customer.name" style="padding:5px; width:200px;">
    </label><br><br>

    <label>é›»è©±ï¼š<br>
      <input v-model="customer.phone" style="padding:5px; width:200px;">
    </label><br><br>

    <button @click="submitOrder" :disabled="isSubmitting || cart.length === 0">
      {{ isSubmitting ? 'é€å‡ºä¸­...' : 'âœ” ç¢ºèªä¸‹å–®' }}
    </button>
  </div>

  <script>
    new Vue({
      el: "#app",
      data() {
        return {          
          products: [],
          cart: [],
          isSubmitting: false,
          customer: { name: "", phone: "" }
        };
      },

      computed: {
        cartTotal() {
          return this.cart.reduce((sum, i) => sum + i.Price * i.quantity, 0);
        }
      },

      methods: {
		// â­ å–å¾—å•†å“è³‡æ–™ï¼ˆé€é Worker Proxyï¼‰
		fetchProducts() {
			fetch("https://bitter-mode-a901.dcwchris.workers.dev/products")
			.then(r => r.json())
			.then(data => {
				this.products = data.products || [];
			})
			.catch(err => console.error("å•†å“è¼‰å…¥éŒ¯èª¤ï¼š", err));
		},

		// â­ åŠ å…¥è³¼ç‰©è»Š
		addToCart(product) {
			const item = this.cart.find(i => i.id === product.id);
			if (item) {
			item.quantity++;
			} else {
			this.cart.push({ ...product, quantity: 1 });
			}
		},
		
		// â­ ç§»é™¤è³¼ç‰©è»Š
		removeFromCart(item) {
			this.cart = this.cart.filter(c => c.id !== item.id);
		},
		
		// â­ é€å‡ºè¨‚å–®ï¼ˆé€é Worker Proxyï¼‰
		submitOrder() {
			if (!this.customer.name || !this.customer.phone) {
				alert("è«‹è¼¸å…¥å§“åèˆ‡é›»è©±");
				return;
			}
			if (this.cart.length === 0) {
				alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
				return;
			}
		
			this.isSubmitting = true;

			const payload = {
				customer: this.customer,
				cart: this.cart
			};

			fetch("https://bitter-mode-a901.dcwchris.workers.dev/submit", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(payload)
			})
			.then(r => r.json())
			.then(res => {
				this.isSubmitting = false;
				alert("âœ” è¨‚å–®æäº¤æˆåŠŸï¼ è¨‚å–®ç·¨è™Ÿï¼š" + res.orderId);

				// æ¸…ç©ºè³¼ç‰©è»Š & å®¢æˆ¶è³‡æ–™
				this.cart = [];
				this.customer = { name: "", phone: "" };
			})
			.catch(err => {
				this.isSubmitting = false;
				alert("âŒ è¨‚å–®é€å‡ºå¤±æ•—");
				console.error(err);
			});
		}
	  },
      mounted() {
        this.fetchProducts();
      }
    });
  </script>

</body>
</html>
