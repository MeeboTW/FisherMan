<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é®®é­šä¸‹å–®ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    .product {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative; /* ç‚ºäº†å®šä½æ„›å¿ƒ */
    }
    /* æ„›å¿ƒæŒ‰éˆ• */
    .fav-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      border: 1px solid #eee;
      user-select: none;
    }
    .fav-btn.active {
      color: red;
    }
    .product img {
      width: 180px;
      height: 180px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    /* æ‰‹æ©Ÿç‰ˆè‡ªå‹•åˆ‡æ›ç‚ºå–®æ¬„æˆ–é›™æ¬„ */
    @media (max-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 480px) {
      .product-grid {
        grid-template-columns: 1fr;
      }
    }
    .cart-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled {
      background: gray;
    }
  </style>
</head>

<body>
  <div id="app">
    <h1>ğŸŸ ä»Šæ—¥æ–°é®®æ¼ç²</h1>
    
    <!-- ç¯©é¸æŒ‰éˆ• -->
    <div style="margin-bottom: 15px;">
      <button @click="showOnlyFav = !showOnlyFav" 
              :style="{ background: showOnlyFav ? '#e91e63' : '#fff', color: showOnlyFav ? 'white' : '#333', border: '1px solid #ddd' }">
        {{ showOnlyFav ? 'â¤ï¸ åªçœ‹æ”¶è—' : 'ğŸ¤ é¡¯ç¤ºæ‰€æœ‰å•†å“' }}
      </button>
    </div>

    <!-- å•†å“åˆ—è¡¨ (4x å®®æ ¼) -->
    <div class="product-grid">
      <div class="product" v-for="p in filteredProducts" :key="p.id">
        <!-- æ„›å¿ƒæŒ‰éˆ• -->
        <div class="fav-btn" :class="{ active: isFav(p.id) }" @click.stop="toggleFav(p.id)">
          {{ isFav(p.id) ? 'â¤ï¸' : 'ğŸ¤' }}
        </div>

        <img v-if="p.ImageURL" :src="p.ImageURL" alt="å•†å“åœ–ç‰‡">
        <div v-else style="width:180px; height:180px; background:#eee; display:flex; align-items:center; justify-content:center; margin-bottom:10px; border-radius:4px;">
          <span style="color:#888;">æš«ç„¡åœ–ç‰‡</span>
        </div>
        
        <h3>{{ p.Name }}</h3>
        <p>åƒ¹æ ¼ï¼š<b>${{ p.Price }}</b></p>
        <button @click="addToCart(p)">åŠ å…¥è³¼ç‰©è»Š</button>
      </div>
    </div>

    <hr>

    <!-- è³¼ç‰©è»Š -->
    <h2>ğŸ›’ è³¼ç‰©è»Š ({{ cart.length }} é …)</h2>

    <div v-if="cart.length === 0">
      <p>è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</p>
    </div>

    <div class="cart-item" v-for="c in cart" :key="c.id">
      {{ c.Name }}  
      â€” ${{ c.Price }}  
      Ã— {{ c.quantity }}

      <button style="background:#d32f2f; float:right;" @click="removeFromCart(c)">
        ç§»é™¤
      </button>
    </div>

    <p v-if="cart.length > 0">
      <b>ç¸½è¨ˆï¼š<span style="color:green">${{ cartTotal }}</span></b>
    </p>

    <hr>

    <!-- è¨‚è³¼è³‡è¨Š -->
    <h2>ğŸ‘¤ è¨‚è³¼äººè³‡è¨Š</h2>

    <!-- Google ç™»å…¥æŒ‰éˆ• (æœªç™»å…¥æ™‚é¡¯ç¤º) -->
    <div v-if="!isLoggedIn" style="margin-bottom: 20px;">
      <div id="g_id_onload"
           data-client_id="783366934600-aumbiora2bdrpf8e135c6vhgpo5gsc6o.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-size="large"
           data-theme="outline"
           data-text="sign_in_with"
           data-shape="rectangular"
           data-logo_alignment="left">
      </div>
      <p style="color: #666; font-size: 14px; margin-top: 5px;">â†‘ æ¨è–¦ä½¿ç”¨ Google ç™»å…¥ï¼Œè‡ªå‹•å¸¶å…¥å§“å</p>
      
      <!-- æ‰‹å‹•è¼¸å…¥å§“å (çµ¦ä¸æƒ³ç™»å…¥çš„äºº) -->
      <div style="margin-top: 15px;">
        <label>å§“åï¼š<br>
          <input v-model="customer.name" style="padding:5px; width:200px;" placeholder="è«‹è¼¸å…¥å§“å">
        </label>
      </div>
    </div>

    <!-- å·²ç™»å…¥é¡¯ç¤ºè³‡è¨Š -->
    <div v-else style="margin-bottom: 20px; padding: 10px; background: #e8f5e9; border-radius: 8px; display: flex; align-items: center;">
      <img :src="googleUser.picture" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
      <div>
        <div><b>{{ googleUser.name }}</b> æ‚¨å¥½ï¼</div>
        <div style="font-size: 12px; color: #666;">{{ googleUser.email }}</div>
      </div>
      <button @click="logout" style="margin-left: auto; background: #9e9e9e; padding: 4px 8px; font-size: 12px;">ç™»å‡º</button>
    </div>

    <!-- é›»è©±æ¬„ä½ (ç„¡è«–æœ‰ç„¡ç™»å…¥éƒ½è¦å¡«) -->
    <label>é›»è©±ï¼š<br>
      <input v-model="customer.phone" style="padding:5px; width:200px;" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
    </label><br><br>

    <!-- è¨‚å–®å‚™è¨» -->
    <label>è¨‚å–®å‚™è¨» (é¸å¡«)ï¼š<br>
      <textarea v-model="customer.note" style="padding:5px; width:100%; max-width:300px; height:50px;" placeholder="ä¾‹å¦‚ï¼šä¸‹åˆäº”é»å–è²¨"></textarea>
    </label><br><br>

    <button @click="submitOrder" :disabled="isSubmitting || cart.length === 0">
      {{ isSubmitting ? 'é€å‡ºä¸­...' : 'âœ” ç¢ºèªä¸‹å–®' }}
    </button>
    
    <div style="text-align: center; margin-top: 20px;">
      <a href="query.html" style="color: #1976d2; text-decoration: none; font-size: 14px;">
        ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚å–®
      </a>
    </div>
    
  </div>

  <script>
    new Vue({
      el: "#app",
      data() {
        return {
          apiUrl: "https://meebo-fish-hc300.dcwchris.workers.dev",
          products: [],
          cart: [],
          isSubmitting: false,
          customer: { name: "", phone: "", note: "" },
          isLoggedIn: false,
          googleUser: {},
          // æ”¶è—åŠŸèƒ½
          favorites: [], // å­˜ ID é™£åˆ—
          showOnlyFav: false
        };
      },

      computed: {
        cartTotal() {
          return this.cart.reduce((sum, i) => sum + i.Price * i.quantity, 0);
        },
        // ç¯©é¸å¾Œçš„å•†å“åˆ—è¡¨
        filteredProducts() {
          if (!this.showOnlyFav) return this.products;
          return this.products.filter(p => this.favorites.includes(p.id));
        }
      },

      mounted() {
        this.fetchProducts();
        
        // 1. è®€å–æ”¶è—ç´€éŒ„
        const savedFav = localStorage.getItem('fish_fav');
        if (savedFav) {
          try { this.favorites = JSON.parse(savedFav); } catch(e) {}
        }

        // 2. è®€å–ä¸Šæ¬¡è¼¸å…¥çš„é›»è©±èˆ‡å‚™è¨» (æŒä¹…åŒ–)
        const savedCustomer = localStorage.getItem('fish_customer');
        if (savedCustomer) {
          try {
            const parsed = JSON.parse(savedCustomer);
            if (parsed.name) this.customer.name = parsed.name;
            if (parsed.phone) this.customer.phone = parsed.phone;
            if (parsed.note) this.customer.note = parsed.note;
          } catch(e) {}
        }

        // 3. è®€å– Google ç™»å…¥ç‹€æ…‹ (æŒä¹…åŒ–)
        const savedUser = localStorage.getItem('fish_user');
        if (savedUser) {
          try {
            this.googleUser = JSON.parse(savedUser);
            this.isLoggedIn = true;
            this.customer.name = this.googleUser.name;
          } catch(e) {}
        }
        
        // å°‡ Vue å¯¦ä¾‹æ›è¼‰åˆ° windowï¼Œè®“ Google callback å‘¼å«å¾—åˆ°
        window.handleCredentialResponse = (response) => {
          console.log("Google Token:", response.credential);
          
          // è§£æ JWT Token
          const responsePayload = this.decodeJwt(response.credential);

          // æ›´æ–° Vue ç‹€æ…‹
          this.isLoggedIn = true;
          this.googleUser = {
            name: responsePayload.name,
            email: responsePayload.email,
            picture: responsePayload.picture
          };
          
          // è‡ªå‹•å¡«å…¥å§“å
          this.customer.name = responsePayload.name;

          // â­ å„²å­˜ç™»å…¥ç‹€æ…‹åˆ° LocalStorage
          localStorage.setItem('fish_user', JSON.stringify(this.googleUser));
        };
      },

      watch: {
        // â­ ç›£è½é›»è©±èˆ‡å‚™è¨»è®Šå‹•ï¼Œè‡ªå‹•å„²å­˜
        'customer.name'(newVal) {
          this.saveCustomerData();
        },
        'customer.phone'(newVal) {
          this.saveCustomerData();
        },
        'customer.note'(newVal) {
          this.saveCustomerData();
        }
      },

      methods: {
        // å„²å­˜å®¢æˆ¶è¼¸å…¥è³‡æ–™
        saveCustomerData() {
          const data = {
            name: this.customer.name,
            phone: this.customer.phone,
            note: this.customer.note
          };
          localStorage.setItem('fish_customer', JSON.stringify(data));
        },

        // æ”¶è—ç›¸é—œ
        isFav(id) {
          return this.favorites.includes(id);
        },
        toggleFav(id) {
          if (this.isFav(id)) {
            this.favorites = this.favorites.filter(fid => fid !== id);
          } else {
            this.favorites.push(id);
          }
          localStorage.setItem('fish_fav', JSON.stringify(this.favorites));
        },

        // JWT è§£ç¢¼å·¥å…·å‡½å¼
        decodeJwt(token) {
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        },
        
        // è¼‰å…¥å•†å“ï¼ˆGETï¼‰
        fetchProducts() {
          console.log("Vue: é–‹å§‹è¼‰å…¥å•†å“...");
          const self = this; // é–å®š thisï¼Œé¿å…ä½œç”¨åŸŸè·‘æ‰

          fetch(this.apiUrl + "/products")
          .then(r => {
            if (!r.ok) throw new Error("HTTP error " + r.status);
            return r.json();
          })
          .then(data => {
            console.log("Vue: æ”¶åˆ°è³‡æ–™", data);
            if (data.products && Array.isArray(data.products)) {
              self.products = data.products;
              console.log("Vue: å•†å“åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± " + self.products.length + " ç­†");
            } else {
              console.error("Vue: è³‡æ–™æ ¼å¼ä¸æ­£ç¢º", data);
            }
          })
          .catch(err => {
            console.error("Vue: å•†å“è¼‰å…¥éŒ¯èª¤", err);
            alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console");
          });
        },

        // åŠ å…¥è³¼ç‰©è»Š
        addToCart(product) {
          const item = this.cart.find(i => i.id === product.id);
          if (item) {
            item.quantity++;
          } else {
            this.cart.push({ ...product, quantity: 1 });
          }
        },

        // ç§»é™¤è³¼ç‰©è»Š
        removeFromCart(item) {
          this.cart = this.cart.filter(c => c.id !== item.id);
        },

        // ç™»å‡º
        logout() {
          this.isLoggedIn = false;
          this.googleUser = {};
          this.customer.name = "";
          
          // æ¸…é™¤ç™»å…¥ç´€éŒ„
          localStorage.removeItem('fish_user');
          
          // phone ä¸æ¸…ç©ºï¼Œè®“ä½¿ç”¨è€…è‡ªå·±æ±ºå®š
          google.accounts.id.disableAutoSelect(); // é¿å…è‡ªå‹•é‡æ–°ç™»å…¥
        },

        // é€å‡ºè¨‚å–®
        submitOrder() {
          if (!this.customer.name) {
            alert("è«‹è¼¸å…¥å§“å");
            return;
          }
          
          // é›»è©±æ ¼å¼æª¢æŸ¥ (ç°¡æ˜“ç‰ˆï¼š0é–‹é ­ï¼Œç¸½å…± 9~10 ä½æ•¸å­—)
          // æ”¯æ´æ‰‹æ©Ÿ 0912345678 (10ç¢¼)
          // æ”¯æ´å¸‚è©± 0223456789 (10ç¢¼) æˆ– 042345678 (9ç¢¼)
          const phoneRegex = /^0\d{8,9}$/;
          if (!this.customer.phone || !phoneRegex.test(this.customer.phone)) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„é›»è©±æ ¼å¼ (ä¾‹å¦‚ 0912345678 æˆ– 0223456789)");
            return;
          }

          if (this.cart.length === 0) {
            alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
            return;
          }

          this.isSubmitting = true;

          const payload = {
            action: "submitOrder",
            customer: {
              ...this.customer,
              email: this.googleUser.email // è£œä¸Š email
            },
            cart: this.cart
          };

          fetch(this.apiUrl + "/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          })
          .then(async r => {
            const data = await r.json();
            if (!r.ok) {
              // å¦‚æœæ˜¯ 429 æˆ–å…¶ä»–éŒ¯èª¤ï¼Œæ‹‹å‡ºå¾Œç«¯å›å‚³çš„ message
              throw new Error(data.message || "ä¼ºæœå™¨éŒ¯èª¤ (" + r.status + ")");
            }
            return data;
          })
          .then(res => {
            this.isSubmitting = false;
            alert("âœ” è¨‚å–®æäº¤æˆåŠŸï¼æ‚¨å¯ä»¥åˆ°æŸ¥è©¢é é¢æŸ¥çœ‹è¨‚å–®ç‹€æ…‹ã€‚");

            // ä¿ç•™å§“åèˆ‡é›»è©±ï¼Œåªæ¸…ç©ºè³¼ç‰©è»Šèˆ‡å‚™è¨»
            this.customer.note = ""; 
            this.cart = [];
          })
          .catch(err => {
            this.isSubmitting = false;
            // é¡¯ç¤ºå…·é«”çš„éŒ¯èª¤è¨Šæ¯
            alert("âŒ " + err.message);
            console.error(err);
          });
        }
      }
    });
  </script>

</body>
</html>
