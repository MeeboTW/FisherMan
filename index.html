<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é®®é­šä¸‹å–®ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    .product {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .product img {
      width: 300px;
      height: 300px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    /* æ‰‹æ©Ÿç‰ˆè‡ªå‹•åˆ‡æ›ç‚ºå–®æ¬„æˆ–é›™æ¬„ */
    @media (max-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 480px) {
      .product-grid {
        grid-template-columns: 1fr;
      }
    }
    .cart-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled {
      background: gray;
    }
    .admin-panel {
      background: #fff3e0;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ffcc80;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- ç®¡ç†å“¡æ¨¡å¼åˆ‡æ› -->
    <div style="text-align:right; margin-bottom:10px;">
      <button @click="isAdmin = !isAdmin" style="background:#607d8b; font-size:12px;">
        {{ isAdmin ? 'åˆ‡æ›å›å•†åº—' : 'ç®¡ç†å“¡ç™»å…¥' }}
      </button>
    </div>

    <!-- â­ ç®¡ç†ä»‹é¢ -->
    <div v-if="isAdmin" class="admin-panel">
      <h2>ğŸ“‹ è¨‚å–®ç®¡ç†ç³»çµ±</h2>
      <button @click="fetchOrders">ğŸ”„ é‡æ–°æ•´ç†è¨‚å–®</button>
      
      <div v-if="orders.length === 0" style="margin-top:10px;">
        <p>ç›®å‰æ²’æœ‰è¨‚å–®</p>
      </div>

      <table v-else>
        <thead>
          <tr>
            <th>è¨‚å–®ç·¨è™Ÿ</th>
            <th>å®¢æˆ¶è³‡æ–™</th>
            <th>è³¼è²·å…§å®¹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="order in orders" :key="order.orderId">
            <td>{{ order.orderId }}</td>
            <td>
              {{ order.data.customer.name }}<br>
              <small>{{ order.data.customer.phone }}</small>
            </td>
            <td>
              <div v-for="item in order.data.cart">
                {{ item.Name }} x {{ item.quantity }}
              </div>
            </td>
            <td>
              <button style="background:#d32f2f; padding:4px 8px;" @click="deleteOrder(order.orderId)">
                åˆªé™¤
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- â­ å•†åº—ä»‹é¢ -->
    <div v-else>
      <h1>ğŸŸ ä»Šæ—¥æ–°é®®æ¼ç²</h1>

    <!-- â­ å•†åº—ä»‹é¢ -->
    <div v-else>
      <h1>ğŸŸ ä»Šæ—¥æ–°é®®æ¼ç²</h1>
      
      <!-- å•†å“åˆ—è¡¨ (ä¹å®®æ ¼) -->
    <div class="product-grid">
      <div class="product" v-for="p in products" :key="p.id">
        <img v-if="p.ImageURL" :src="p.ImageURL" alt="å•†å“åœ–ç‰‡">
        <div v-else style="width:300px; height:300px; background:#eee; display:flex; align-items:center; justify-content:center; margin-bottom:10px; border-radius:4px;">
          <span style="color:#888;">æš«ç„¡åœ–ç‰‡</span>
        </div>
        
        <h3>{{ p.Name }}</h3>
        <p>åƒ¹æ ¼ï¼š<b>${{ p.Price }}</b></p>
        <button @click="addToCart(p)">åŠ å…¥è³¼ç‰©è»Š</button>
      </div>
    </div>

    <hr>

    <!-- è³¼ç‰©è»Š -->
    <h2>ğŸ›’ è³¼ç‰©è»Š ({{ cart.length }} é …)</h2>

    <div v-if="cart.length === 0">
      <p>è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</p>
    </div>

    <div class="cart-item" v-for="c in cart" :key="c.id">
      {{ c.Name }}  
      â€” ${{ c.Price }}  
      Ã— {{ c.quantity }}

      <button style="background:#d32f2f; float:right;" @click="removeFromCart(c)">
        ç§»é™¤
      </button>
    </div>

    <p v-if="cart.length > 0">
      <b>ç¸½è¨ˆï¼š<span style="color:green">${{ cartTotal }}</span></b>
    </p>

    <hr>

    <!-- è¨‚è³¼è³‡è¨Š -->
    <h2>ğŸ‘¤ è¨‚è³¼äººè³‡è¨Š</h2>

    <label>å§“åï¼š<br>
      <input v-model="customer.name" style="padding:5px; width:200px;">
    </label><br><br>

    <label>é›»è©±ï¼š<br>
      <input v-model="customer.phone" style="padding:5px; width:200px;">
    </label><br><br>

      <button @click="submitOrder" :disabled="isSubmitting || cart.length === 0">
        {{ isSubmitting ? 'é€å‡ºä¸­...' : 'âœ” ç¢ºèªä¸‹å–®' }}
      </button>
    </div>
  </div>

  <script>
    new Vue({
      el: "#app",
      data() {
        return {
          apiUrl: "https://meebo-fish-hc300.dcwchris.workers.dev",
          isAdmin: false, // æ˜¯å¦ç‚ºç®¡ç†å“¡æ¨¡å¼
          products: [],
          cart: [],
          orders: [], // è¨‚å–®åˆ—è¡¨
          isSubmitting: false,
          customer: { name: "", phone: "" }
        };
      },

      computed: {
        cartTotal() {
          return this.cart.reduce((sum, i) => sum + i.Price * i.quantity, 0);
        }
      },

      methods: {
        // è¼‰å…¥å•†å“ï¼ˆGETï¼‰
        fetchProducts() {
          console.log("é–‹å§‹è¼‰å…¥å•†å“...");
          fetch(this.apiUrl + "/products")
          .then(r => r.json())
          .then(data => {
            this.products = data.products || [];
          })
          .catch(err => console.error("å•†å“è¼‰å…¥éŒ¯èª¤ï¼š", err));
        },

        // åŠ å…¥è³¼ç‰©è»Š
        addToCart(product) {
          const item = this.cart.find(i => i.id === product.id);
          if (item) {
            item.quantity++;
          } else {
            this.cart.push({ ...product, quantity: 1 });
          }
        },

        // ç§»é™¤è³¼ç‰©è»Š
        removeFromCart(item) {
          this.cart = this.cart.filter(c => c.id !== item.id);
        },

        // é€å‡ºè¨‚å–®
        submitOrder() {
          if (!this.customer.name || !this.customer.phone) {
            alert("è«‹è¼¸å…¥å§“åèˆ‡é›»è©±");
            return;
          }
          if (this.cart.length === 0) {
            alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
            return;
          }

          this.isSubmitting = true;

          const payload = {
            action: "submitOrder",
            customer: this.customer,
            cart: this.cart
          };

          fetch(this.apiUrl + "/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          })
          .then(r => r.json())
          .then(res => {
            this.isSubmitting = false;
            alert("âœ” è¨‚å–®æäº¤æˆåŠŸï¼");

            // æ¸…ç©º
            this.customer = { name: "", phone: "" };
            this.cart = [];
            
            // å¦‚æœåœ¨ç®¡ç†æ¨¡å¼ä¸‹ï¼Œé †ä¾¿åˆ·æ–°è¨‚å–®
            if (this.isAdmin) this.fetchOrders();
          })
          .catch(err => {
            this.isSubmitting = false;
            alert("âŒ è¨‚å–®é€å‡ºå¤±æ•—");
            console.error(err);
          });
        },

        // ğŸ¢ ç®¡ç†å“¡ï¼šè®€å–è¨‚å–®
        fetchOrders() {
          fetch(this.apiUrl + "/orders")
          .then(r => r.json())
          .then(data => {
            this.orders = data.orders || [];
          })
          .catch(err => console.error("è®€å–è¨‚å–®å¤±æ•—", err));
        },

        // ğŸ¢ ç®¡ç†å“¡ï¼šåˆªé™¤è¨‚å–®
        deleteOrder(id) {
          if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ")) return;

          fetch(this.apiUrl + "/orders/delete/" + id, {
            method: "DELETE"
          })
          .then(r => r.json())
          .then(res => {
            alert("è¨‚å–®å·²åˆªé™¤");
            this.fetchOrders(); // é‡æ–°æ•´ç†
          })
          .catch(err => alert("åˆªé™¤å¤±æ•—"));
        }
      },

      mounted() {
        // æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰ ?admin=true
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('admin')) {
          this.isAdmin = true;
          this.fetchOrders();
        }

        this.fetchProducts();
      }
    });
  </script>

</body>
</html>
