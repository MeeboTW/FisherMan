<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é®®é­šä¸‹å–®ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .product-card img { height: 200px; object-fit: cover; }
        .cart-fixed { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body>

<div id="app" class="container py-4">
    <h1 class="text-center mb-4">ğŸŸ ä»Šæ—¥æ–°é®®é­šè²¨</h1>

    <!-- å•†å“åˆ—è¡¨ -->
    <div class="row row-cols-1 row-cols-md-3 g-4">
        <div class="col" v-for="product in products" :key="product.ID">
            <div class="card h-100 shadow-sm product-card">
                <!-- å¦‚æœæœ‰åœ–ç‰‡é€£çµå°±é¡¯ç¤ºï¼Œæ²’æœ‰å°±é¡¯ç¤ºé è¨­åœ– -->
                <img :src="product.ImageURL || 'https://via.placeholder.com/300?text=No+Image'" class="card-img-top" alt="...">
                <div class="card-body">
                    <h5 class="card-title">{{ product.Name }}</h5>
                    <p class="card-text text-danger fw-bold">${{ product.Price }}</p>
                    <button class="btn btn-primary w-100" @click="addToCart(product)">
                        åŠ å…¥è³¼ç‰©è»Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è³¼ç‰©è»ŠæŒ‰éˆ• (æµ®å‹•) -->
    <button class="btn btn-warning cart-fixed rounded-circle p-3 shadow" @click="showCart = true">
        ğŸ›’ {{ cart.length }}
    </button>

    <!-- çµå¸³ Modal -->
    <div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);" v-if="showCart">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ‚¨çš„è³¼ç‰©è»Š</h5>
                    <button type="button" class="btn-close" @click="showCart = false"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between lh-sm" v-for="(item, index) in cart" :key="index">
                            <div>
                                <h6 class="my-0">{{ item.Name }}</h6>
                            </div>
                            <span class="text-muted">${{ item.Price }}</span>
                            <button class="btn btn-sm btn-danger ms-2" @click="removeFromCart(index)">x</button>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>ç¸½è¨ˆ (å°å¹£)</span>
                            <strong>${{ cartTotal }}</strong>
                        </li>
                    </ul>

                    <form @submit.prevent="submitOrder">
                        <div class="mb-3">
                            <label class="form-label">æ‚¨çš„å§“å</label>
                            <input type="text" class="form-control" v-model="customer.name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é›»è©±è™Ÿç¢¼</label>
                            <input type="tel" class="form-control" v-model="customer.phone" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100" :disabled="isSubmitting">
                            {{ isSubmitting ? 'é€å‡ºä¸­...' : 'ç¢ºèªä¸‹å–®' }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
<script>
    const app = Vue.createApp({
        data() {
            return {
                // *** é‡è¦ï¼šè«‹æŠŠé€™è£¡æ›æˆä½ å‰›å‰›åœ¨ Step 3 æ‹¿åˆ°çš„ Web App URL ***
                apiUrl: 'https://script.google.com/macros/s/AKfycbwOky-1pjVqbW6w4NEyLSd047BRROlQJ5yNdmOdyi1KDL08KkVimVsgemL91kKjNI2U/exec', 
                
                products: [],
                cart: [],
                showCart: false,
                isSubmitting: false,
                customer: { name: '', phone: '' }
            }
        },
        computed: {
            cartTotal() {
                return this.cart.reduce((sum, item) => sum + Number(item.Price), 0);
            }
        },
        mounted() {
            this.fetchProducts();
        },
        methods: {
            fetchProducts() {
                fetch(this.apiUrl)
                    .then(res => res.json())
                    .then(data => {
                        this.products = data;
                    })
                    .catch(err => alert('è®€å–å•†å“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Script è¨­å®š'));
            },
            addToCart(product) {
                this.cart.push(product);
                alert('å·²åŠ å…¥ï¼š' + product.Name);
            },
            removeFromCart(index) {
                this.cart.splice(index, 1);
            },
            submitOrder() {
                if (this.cart.length === 0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
                
                this.isSubmitting = true;
                const orderData = {
                    name: this.customer.name,
                    phone: this.customer.phone,
                    items: this.cart.map(p => p.Name).join(', '),
                    total: this.cartTotal
                };

                // ä½¿ç”¨ fetch é€å‡º POST è«‹æ±‚ (æ³¨æ„ mode: 'no-cors' çš„ç´°ç¯€)
                // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡ç”¨ text/plain é¿å…è¤‡é›œçš„ CORS é æª¢
                fetch(this.apiUrl, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                })
                .then(res => res.json())
                .then(res => {
                    alert('ä¸‹å–®æˆåŠŸï¼è€é—†æœƒç›¡å¿«è¯çµ¡æ‚¨ã€‚');
                    this.cart = [];
                    this.showCart = false;
                    this.isSubmitting = false;
                })
                .catch(err => {
                    // å› ç‚º Google Script çš„è·³è½‰ç‰¹æ€§ï¼Œæœ‰æ™‚å€™é›–ç„¶æˆåŠŸä½†æœƒå ±éŒ¯ï¼Œé€šå¸¸é€™æ®µè¦å¯«å¾—æ›´åš´è¬¹
                    // ä½†ç°¡æ˜“ç‰ˆé€™æ¨£é€šå¸¸è³‡æ–™å·²ç¶“é€²å»äº†
                    console.error(err);
                    alert('è¨‚å–®å·²é€å‡º (æˆ–ç™¼ç”Ÿç¶²è·¯å•é¡Œ)ï¼Œè«‹ç¢ºèªè€é—†æ˜¯å¦æ”¶åˆ°ã€‚');
                    this.isSubmitting = false;
                });
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
