<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®æŸ¥è©¢ - é®®é­šä¸‹å–®ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      width: 100%;
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background: gray;
    }
    .order-card {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      background: #fafafa;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px dashed #ddd;
      padding-bottom: 5px;
    }
    .status {
      font-weight: bold;
      font-size: 14px;
      padding: 2px 6px;
      border-radius: 4px;
      color: white;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #666;
      text-decoration: none;
    }
    /* åˆ†é ç±¤ */
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      color: #666;
    }
    .tab.active {
      color: #1976d2;
      border-bottom: 2px solid #1976d2;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="app" class="container">
    <h1>ğŸ” æŸ¥è©¢æ­·å²è¨‚å–®</h1>
    
    <div class="tabs">
      <div class="tab" :class="{ active: mode === 'phone' }" @click="mode = 'phone'">é›»è©±æŸ¥è©¢</div>
      <div class="tab" :class="{ active: mode === 'google' }" @click="mode = 'google'">æœƒå“¡æŸ¥è©¢</div>
    </div>

    <!-- é›»è©±æŸ¥è©¢æ¨¡å¼ -->
    <div v-if="mode === 'phone'">
      <p style="color:#666; text-align:center; margin-bottom:20px;">
        è«‹è¼¸å…¥ä¸‹å–®æ™‚å¡«å¯«çš„é›»è©±è™Ÿç¢¼
      </p>
      <input v-model="searchPhone" type="tel" placeholder="ä¾‹å¦‚ï¼š0912345678" @keyup.enter="searchByPhone">
      <button @click="searchByPhone" :disabled="isSearching">
        {{ isSearching ? 'æŸ¥è©¢ä¸­...' : 'æŸ¥è©¢' }}
      </button>
    </div>

    <!-- Google æŸ¥è©¢æ¨¡å¼ -->
    <div v-else>
      <div v-if="!isLoggedIn" style="text-align: center;">
        <p style="color:#666; margin-bottom:20px;">ç™»å…¥ Google å¸³è™Ÿï¼Œä¸€éµæŸ¥çœ‹æ‰€æœ‰è¨‚å–®</p>
        <div id="g_id_onload"
             data-client_id="783366934600-aumbiora2bdrpf8e135c6vhgpo5gsc6o.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="center">
        </div>
      </div>
      <div v-else>
        <p style="text-align: center; color:#666;">
          Hi, <b>{{ googleUser.name }}</b><br>
          æ­£åœ¨é¡¯ç¤º {{ googleUser.email }} çš„è¨‚å–®
        </p>
        <button @click="logout" style="background:#999; margin-bottom:10px; font-size:14px; padding:8px;">ç™»å‡º</button>
      </div>
    </div>

    <!-- æŸ¥è©¢çµæœ -->
    <div v-if="hasSearched" style="margin-top: 20px;">
      <div v-if="searchResult.length === 0" style="text-align: center; color: #888;">
        æŸ¥ç„¡è³‡æ–™ã€‚
      </div>

      <div v-else>
        <div v-for="o in searchResult" :key="o.orderId" class="order-card">
          <div class="order-header">
            <span style="font-weight: bold;">{{ formatDate(o.createdAt) }}</span>
            <span class="status" :style="{ background: getStatusColor(o.status) }">
              {{ getStatusText(o.status) }}
            </span>
          </div>
          
          <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
            å–®è™Ÿ: {{ o.orderId }}
          </div>

          <div style="font-size: 15px; line-height: 1.6;">
            <div v-for="item in o.cart">
              {{ item.Name }} x {{ item.quantity }}
            </div>
          </div>

          <div style="text-align: right; font-weight: bold; margin-top: 10px; font-size: 18px; color: #333;">
            ç¸½è¨ˆ: ${{ o.total }}
          </div>
        </div>
      </div>
    </div>

    <a href="index.html" class="back-link">â† è¿”å›å•†åº—é¦–é </a>
  </div>

  <script>
    new Vue({
      el: "#app",
      data() {
        return {
          apiUrl: "https://meebo-fish-hc300.dcwchris.workers.dev",
          mode: 'phone', // 'phone' or 'google'
          searchPhone: "",
          searchResult: [],
          isSearching: false,
          hasSearched: false,
          // Google
          isLoggedIn: false,
          googleUser: {}
        };
      },

      mounted() {
        // åˆå§‹åŒ– Google ç™»å…¥ callback
        window.handleCredentialResponse = (response) => {
          const payload = this.decodeJwt(response.credential);
          this.isLoggedIn = true;
          this.googleUser = {
            name: payload.name,
            email: payload.email
          };
          // è‡ªå‹•æŸ¥å–®
          this.searchByEmail(payload.email);
        };
      },

      methods: {
        decodeJwt(token) {
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        },

        logout() {
          this.isLoggedIn = false;
          this.googleUser = {};
          this.searchResult = [];
          this.hasSearched = false;
          google.accounts.id.disableAutoSelect();
        },

        // é›»è©±æŸ¥è©¢
        searchByPhone() {
          if (!this.searchPhone) {
            alert("è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼");
            return;
          }
          this.doSearch("/orders/search?phone=" + this.searchPhone);
        },

        // Email æŸ¥è©¢
        searchByEmail(email) {
          this.doSearch("/orders/my?email=" + email);
        },

        // çµ±ä¸€åŸ·è¡ŒæŸ¥è©¢
        doSearch(endpoint) {
          this.isSearching = true;
          this.hasSearched = false;
          this.searchResult = [];

          fetch(this.apiUrl + endpoint)
          .then(r => r.json())
          .then(data => {
            this.searchResult = data.orders || [];
            this.hasSearched = true;
            this.isSearching = false;
          })
          .catch(err => {
            console.error(err);
            alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            this.isSearching = false;
          });
        },

        formatDate(isoStr) {
          if (!isoStr) return '';
          try {
            return new Date(isoStr).toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
          } catch(e) { return ''; }
        },

        getStatusText(status) {
          const map = { 'pending': 'æœªè™•ç†', 'completed': 'å·²å®Œæˆ', 'cancelled': 'å·²å–æ¶ˆ' };
          return map[status || 'pending'] || 'æœªè™•ç†';
        },

        getStatusColor(status) {
          const map = { 'pending': '#ff9800', 'completed': '#4caf50', 'cancelled': '#9e9e9e' };
          return map[status || 'pending'] || '#ff9800';
        }
      }
    });
  </script>
</body>
</html>
