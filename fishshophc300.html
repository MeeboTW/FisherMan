<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é®®é­šå¾Œå°ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    
    /* 1. å„€è¡¨æ¿æ¨£å¼ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      border-left: 5px solid #1976d2;
    }
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .admin-panel {
      background: #fff3e0;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ffcc80;
      border-radius: 8px;
    }

    /* 2. æœå°‹ç¯©é¸å€æ¨£å¼ */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 200px;
      font-size: 14px;
    }
    .filter-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }

    /* ç‹€æ…‹æ¨™ç±¤ */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      min-width: 50px;
      text-align: center;
    }
    .status-pending { background-color: #ff9800; }
    .status-completed { background-color: #4caf50; }
    .status-cancelled { background-color: #9e9e9e; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      font-size: 14px;
    }
    button:disabled {
      background: gray;
    }
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
  </style>
</head>

<body>
  <div id="app">
    <h1>ğŸ“‹ è¨‚å–®ç®¡ç†ç³»çµ±</h1>
    <p><a href="index.html">â† è¿”å›å•†åº—å‰å°</a></p>

    <!-- â­ 1. ç‡Ÿé‹å„€è¡¨æ¿ -->
    <div class="dashboard">
      <div class="stat-card" style="border-left-color: #4caf50;">
        <div class="stat-label">ä»Šæ—¥ç‡Ÿæ¥­é¡</div>
        <div class="stat-value" style="color: #2e7d32;">${{ stats.todayRevenue }}</div>
      </div>
      <div class="stat-card" style="border-left-color: #2196f3;">
        <div class="stat-label">ä»Šæ—¥è¨‚å–®æ•¸</div>
        <div class="stat-value">{{ stats.todayCount }} å¼µ</div>
      </div>
      <div class="stat-card" style="border-left-color: #ff9800;">
        <div class="stat-label">å¾…è™•ç†è¨‚å–®</div>
        <div class="stat-value" style="color: #ef6c00;">{{ stats.pendingCount }} å¼µ</div>
      </div>
    </div>

    <div class="admin-panel">
      <!-- â­ 2. æœå°‹èˆ‡ç¯©é¸å·¥å…·åˆ— -->
      <div class="controls">
        <button style="background: #1976d2;" @click="fetchOrders">ğŸ”„ é‡æ–°æ•´ç†</button>
        
        <select v-model="filterStatus" class="filter-select">
          <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
          <option value="pending">ğŸ”´ æœªè™•ç† ({{ stats.pendingCount }})</option>
          <option value="completed">ğŸŸ¢ å·²å®Œæˆ</option>
          <option value="cancelled">âšª å·²å–æ¶ˆ</option>
        </select>

        <input type="text" v-model="searchQuery" class="search-box" placeholder="ğŸ” æœå°‹è¨‚å–®ç·¨è™Ÿã€å§“åã€é›»è©±...">
      </div>

      <div v-if="orders.length === 0" style="margin-top:10px;">
        <p>ç›®å‰æ²’æœ‰è¨‚å–®</p>
      </div>

      <table v-else>
        <thead>
          <tr>
            <th width="80">ç‹€æ…‹</th>
            <th width="150">è¨‚å–®ç·¨è™Ÿ</th>
            <th width="150">å®¢æˆ¶è³‡æ–™</th>
            <th>è³¼è²·å…§å®¹</th>
            <th width="100">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <!-- æ³¨æ„ï¼šé€™è£¡æ”¹æˆç”¨ sortedOrders (å·²ç¯©é¸éçš„åˆ—è¡¨) -->
          <tr v-for="order in sortedOrders" :key="order.orderId">
            <td>
              <span :class="'status-badge status-' + (order.data.status || 'pending')">
                {{ getStatusText(order.data.status) }}
              </span>
            </td>
            <td>
              {{ order.orderId }}<br>
              <small style="color:#888">{{ formatDate(order.data.createdAt) }}</small>
            </td>
            <td>
              {{ order.data.customer ? order.data.customer.name : 'ç„¡å§“å' }}<br>
              <small>{{ order.data.customer ? order.data.customer.phone : 'ç„¡é›»è©±' }}</small>
            </td>
            <td>
              <div v-if="order.data.cart">
                <div v-for="item in order.data.cart">
                  {{ item.Name }} x {{ item.quantity }}
                </div>
                <div style="margin-top:5px; border-top:1px dashed #eee; padding-top:5px; font-weight:bold; color:green;">
                   ç¸½è¨ˆ: ${{ calcTotal(order.data.cart) }}
                </div>
              </div>
              <div v-else style="color:red;">(è³‡æ–™ç¼ºæ)</div>
            </td>
            <td>
              <div class="action-buttons">
                <button v-if="(order.data.status || 'pending') !== 'completed'" 
                        style="background:#4caf50;" 
                        @click="updateStatus(order.orderId, 'completed')">
                  âœ… å®Œæˆ
                </button>

                <button v-if="(order.data.status || 'pending') === 'completed'" 
                        style="background:#ff9800;" 
                        @click="updateStatus(order.orderId, 'pending')">
                  â†©ï¸ é‡ç½®
                </button>

                <button style="background:#d32f2f;" @click="deleteOrder(order.orderId)">
                  ğŸ—‘ï¸ åˆªé™¤
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    new Vue({
      el: "#app",
      data() {
        return {
          apiUrl: "https://meebo-fish-hc300.dcwchris.workers.dev",
          orders: [], // åŸå§‹è¨‚å–®åˆ—è¡¨
          searchQuery: "", // æœå°‹é—œéµå­—
          filterStatus: "all" // ç‹€æ…‹ç¯©é¸
        };
      },

      computed: {
        // â­ å³æ™‚çµ±è¨ˆæ•¸æ“š
        stats() {
          // å–å¾—ä»Šæ—¥æ—¥æœŸå­—ä¸² (ä¾‹å¦‚ 2023/11/30)
          const todayStr = new Date().toLocaleDateString();
          let todayRevenue = 0;
          let todayCount = 0;
          let pendingCount = 0;

          this.orders.forEach(o => {
            const data = o.data;
            const status = data.status || 'pending';

            // è¨ˆç®—å¾…è™•ç† (ä¸ç®¡æ˜¯å¦ç‚ºä»Šæ—¥)
            if (status === 'pending') {
              pendingCount++;
            }

            // è¨ˆç®—ä»Šæ—¥æ¥­ç¸¾ (æ’é™¤å·²å–æ¶ˆ)
            if (status !== 'cancelled' && data.createdAt) {
              const d = new Date(data.createdAt).toLocaleDateString();
              if (d === todayStr) {
                todayCount++;
                todayRevenue += this.calcTotal(data.cart);
              }
            }
          });

          return { todayRevenue, todayCount, pendingCount };
        },

        // â­ ç¯©é¸èˆ‡æ’åºé‚è¼¯
        sortedOrders() {
          // 1. å…ˆéæ¿¾
          let list = this.orders.filter(o => {
            const data = o.data;
            const status = data.status || 'pending';

            // ç‹€æ…‹ç¯©é¸
            if (this.filterStatus !== 'all' && status !== this.filterStatus) {
              return false;
            }

            // é—œéµå­—æœå°‹ (æ”¯æ´ ID, å§“å, é›»è©±)
            if (this.searchQuery) {
              const q = this.searchQuery.toLowerCase();
              const id = o.orderId.toLowerCase();
              const name = (data.customer?.name || '').toLowerCase();
              const phone = (data.customer?.phone || '').toLowerCase();
              
              return id.includes(q) || name.includes(q) || phone.includes(q);
            }
            
            return true;
          });

          // 2. å†æ’åº (æœªè™•ç†å„ªå…ˆ > æ™‚é–“æ–°åˆ°èˆŠ)
          return list.sort((a, b) => {
            const statusA = (a.data.status || 'pending') === 'pending' ? 1 : 0;
            const statusB = (b.data.status || 'pending') === 'pending' ? 1 : 0;
            
            if (statusA !== statusB) return statusB - statusA;
            return b.orderId.localeCompare(a.orderId);
          });
        }
      },

      methods: {
        getStatusText(status) {
          const map = { 'pending': 'æœªè™•ç†', 'completed': 'å·²å®Œæˆ', 'cancelled': 'å·²å–æ¶ˆ' };
          return map[status] || 'æœªè™•ç†';
        },
        
        formatDate(isoStr) {
          if (!isoStr) return '';
          try {
            const d = new Date(isoStr);
            return d.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
          } catch(e) { return ''; }
        },

        calcTotal(cart) {
          if (!cart) return 0;
          return cart.reduce((sum, i) => sum + (Number(i.Price) * Number(i.quantity)), 0);
        },

        updateStatus(id, newStatus) {
          fetch(this.apiUrl + "/orders/update/" + id, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus })
          })
          .then(r => r.json())
          .then(res => {
            const order = this.orders.find(o => o.orderId === id);
            if (order) {
              order.data.status = newStatus;
              this.orders = [...this.orders]; // è§¸ç™¼æ›´æ–°
            }
          })
          .catch(err => alert("ç‹€æ…‹æ›´æ–°å¤±æ•—"));
        },

        fetchOrders() {
          console.log("Vue: é–‹å§‹è¼‰å…¥è¨‚å–®åˆ—è¡¨...");
          fetch(this.apiUrl + "/orders")
          .then(r => r.json())
          .then(data => {
            console.log("Vue: æ”¶åˆ°è¨‚å–®è³‡æ–™", data);
            this.orders = data.orders || [];
          })
          .catch(err => console.error("è®€å–è¨‚å–®å¤±æ•—", err));
        },

        deleteOrder(id) {
          if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ")) return;

          fetch(this.apiUrl + "/orders/delete/" + id, {
            method: "DELETE"
          })
          .then(r => r.json())
          .then(res => {
            this.orders = this.orders.filter(o => o.orderId !== id);
          })
          .catch(err => alert("åˆªé™¤å¤±æ•—"));
        }
      },

      mounted() {
        this.fetchOrders();
      }
    });
  </script>

</body>
</html>
